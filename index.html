<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Pro Edition - VMHSS MLP</title>

  <!-- Google Fonts + Main CSS -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Poppins, Arial, sans-serif; margin:0; padding:12px; background:linear-gradient(135deg,#feda75,#fa7e1e,#d62976,#962fbf,#4f5bd5); color:#fff; }
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px; background:#2c3e50; color:#fff; border-radius:10px;}
    .container{display:flex; gap:20px; flex-wrap:wrap; max-width:1200px; margin:10px auto;}
    .card, .student-list, .student-form, .analytics-section{background:rgba(255,255,255,0.08); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.12);}
    .student-list, .student-form, .analytics-section{flex:1 1 300px; min-width:300px; max-height:600px; overflow-y:auto;}
    h2{margin-top:0;}
    input, select, button{font-family:inherit; padding:6px; border-radius:6px; border:none;}
    button{cursor:pointer; background:#3498db; color:#fff;}
    button:hover{background:#2980b9;}
    ul{list-style:none; padding:0; margin:0;}
    li{padding:8px; border-bottom:1px solid rgba(255,255,255,0.2); display:flex; justify-content:space-between; align-items:center;}
    .marks-inputs div{margin-bottom:10px;}
    .marks-inputs label{display:inline-block; width:120px;}
    .marks-inputs input, .marks-inputs select{width:100px;}
    .controls{margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;}
    @media (max-width:800px){.container{flex-direction:column;}}
  </style>
</head>

<body>
  <!-- Header with top controls -->
  <header>
    <h1>Teacher Pro Edition - VMHSS Marks Manager</h1>
    <div id="topControls" style="display:flex;gap:8px;align-items:center;">
      <input id="searchBox" type="search" placeholder="ðŸ”Ž Search student by name or roll..." />
      <button onclick="toggleBulkMode()">Bulk Entry</button>
      <button onclick="copyPreviousExam()">Copy Prev Exam</button>
      <button onclick="markAllPresent()">Mark All Present</button>
      <label class="switch" title="Dark mode"><input id="darkModeToggle" type="checkbox" onchange="toggleDarkMode()"><span class="slider round" style="margin-left:6px;"></span></label>
      <button onclick="downloadBackup()">Backup (JSON)</button>
      <button onclick="deleteAllStudents()">Delete All</button>
    </div>
  </header>

  <!-- Main container -->
  <main class="container">
    <!-- Left Column: Exams + Student List -->
    <section style="width:35%; min-width:300px;">
      <!-- Exam Selector -->
      <div id="examSection" style="margin-bottom:12px;">
        <h2>Select Exam</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <select id="examSelect" onchange="changeExam()" style="flex:1;">
            <option value="">-- Select Exam --</option>
            <optgroup label="Cycle Tests">
              <option value="cycleTest1">Cycle Test 1</option>
              <option value="cycleTest2">Cycle Test 2</option>
              <option value="cycleTest3">Cycle Test 3</option>
              <option value="cycleTest4">Cycle Test 4</option>
              <option value="cycleTest5">Cycle Test 5</option>
              <option value="cycleTest6">Cycle Test 6</option>
              <option value="cycleTest7">Cycle Test 7</option>
              <option value="cycleTest8">Cycle Test 8</option>
              <option value="cycleTest9">Cycle Test 9</option>
              <option value="cycleTest10">Cycle Test 10</option>
            </optgroup>
            <optgroup label="Mid Terms">
              <option value="midTerm1">Mid Term 1</option>
              <option value="midTerm2">Mid Term 2</option>
              <option value="midTerm3">Mid Term 3</option>
            </optgroup>
            <option value="quarterly">Quarterly</option>
            <option value="halfYearly">Half Yearly</option>
            <option value="annual">Annual</option>
          </select>
          <select id="copyExamSelect" style="width:220px;">
            <option value="">Copy students from...</option>
          </select>
          <button onclick="copyNamesFromSelectedExam()">Copy Names</button>
        </div>
        <div id="subExamNumberDiv" style="margin-top:8px; display:none;">
          <label for="subExamNumber">Select Test Number</label>
          <select id="subExamNumber" onchange="loadStudentsForSelectedExam()"></select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button onclick="downloadExcel()">Export CSV</button>
          <button onclick="downloadPDF()">Export PDF</button>
          <button onclick="exportClassSummaryPDF()">Class Summary</button>
        </div>
      </div>

      <!-- Student List -->
      <div id="studentList">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2>Student List</h2>
          <div style="display:flex; gap:8px;">
            <button onclick="addStudent()">Add Student</button>
            <button onclick="openImportDialog()">Import CSV/JSON</button>
          </div>
        </div>
        <ul id="list" style="max-height:60vh; overflow:auto;"></ul>
        <div id="summaryInfo" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- Right Column: Marks Form / Bulk Entry / Analytics -->
    <section style="width:60%; min-width:320px;">
      <!-- Marks Form -->
      <div id="markForm">
        <h2>Enter Student Marks</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <input type="text" id="name" placeholder="Student Name">
          <select id="class" onchange="updateSectionOptions()">
            <option value="">Select Class</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
            <option value="11">11</option><option value="12">12</option>
          </select>
          <select id="section" onchange="updateSubjectFields()">
            <option value="">Select Section</option>
          </select>
        </div>

        <div id="marksInputs"></div>
        <p id="percentageDisplay" style="font-weight:bold;"></p>

        <div class="controls">
          <button onclick="saveMarks()">Save Marks</button>
          <button onclick="saveAndNext()">Save & Next</button>
          <button onclick="fillAbsentZero()">Fill Absent 0</button>
          <button onclick="autoFillAttendance()">Mark All Present</button>
        </div>
      </div>

      <!-- Bulk Entry -->
      <div id="bulkEntry" style="margin-top:12px; display:none;">
        <h2>Bulk Entry</h2>
        <div style="overflow:auto; max-height:420px;">
          <table id="bulkTable" style="width:100%; border-collapse:collapse;"></table>
        </div>
        <div class="controls">
          <button onclick="applyQuickFill()">Quick Fill</button>
          <button onclick="saveBulkChanges()">Save Bulk</button>
        </div>
      </div>

      <!-- Charts / Analytics -->
      <div id="chartsCard" style="margin-top:12px;">
        <h2>Exam Comparison</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <label>Exam A</label>
          <select id="compareExamA" onchange="updateComparisonChart()"></select>
          <label>Exam B</label>
          <select id="compareExamB" onchange="updateComparisonChart()"></select>
          <button onclick="generateComparison()">Generate</button>
        </div>
        <canvas id="comparisonChart" width="800" height="250"></canvas>
        <div class="controls" style="margin-top:8px;">
          <button onclick="generateProgressReport()">Student Progress Report</button>
          <button onclick="generateClassSummary()">Class Summary</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Hidden import input -->
  <input id="importFile" type="file" accept=".csv,application/json" style="display:none" onchange="handleImportFile(event)" />

  <!-- Placeholder for modals -->
  <div id="modalRoot"></div>

  <script src="script.js"></script>

  <!-- Auto-populate copy exam select -->
  <script>
    (function populateCopySelect() {
      try {
        const sel = document.getElementById('copyExamSelect');
        if (!sel) return;
        const list = [];
        for (let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.startsWith('exam_') || /^(cycleTest|midTerm|quarterly|halfYearly|annual)/i.test(k)) list.push(k.replace(/^exam_/, ''));
        }
        Array.from(new Set(list)).sort().forEach(name => {
          const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
          sel.appendChild(opt);
        });
      } catch(e){console.warn(e);}
    })();
  </script>
</body>
</html>
